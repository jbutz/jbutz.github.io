<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Jason Butz - Etsy Deployinator Environments</title>
	<meta name="viewport" content="width=device-width">

	<link rel="alternate" type="application/rss+xml" title="Blog Feed" href="http://www.jasonbutz.info/blog/atom.xml" />
	<link rel="alternate" type="application/rss+xml" title="Projects Feed" href="http://www.jasonbutz.info/project/atom.xml" />

	<!-- Foundation -->
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/css/normalize.min.css"/>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/css/foundation.min.css"/>
	<link rel="stylesheet" href="/assets/css/social_foundicons.css"/>

	<link rel="stylesheet" href="/assets/css/syntax.css">
	<link rel="stylesheet" type="text/css" href="/assets/css/style.css" />

	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/vendor/custom.modernizr.min.js"></script>
	<script type="text/javascript" src="/assets/js/plugins.js"></script>
</head>
<body>
	<header>
		<div class="row">
			<div class="small-8 large-6 columns">
				<h1><a href="/">Jason Butz</a></h1>
			</div>
			<div class="small-4 large-6 columns">
				<nav class="contain-to-grid">
					<div class="top-bar">
						<ul class="title-area">
							<li class="name"><!-- Leave this empty --></li>
							<li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
						</ul>
						<section class="top-bar-section">
							<ul class="right">
								<li class="active"><a href="/">Home</a></li>
								<li><a href="/projects.html">Projects</a></li>
								<li><a href="/blog">Blog</a></li>
								<li><a href="/contact.html">Contact Me</a></li>
							</ul>
						</section>
					</div>
				</nav>
			</div>
		</div>
	</header>

	<section id="mainContent">
		<div class="small-12 large-8 large-centered columns">
<div class="row">
	<div class="small-12 columns">
		<h2>Etsy Deployinator Environments <small>31 Jul 2013</small></h2>
	</div>
</div>
<div class="row">
	<div class="small-12 columns">
		<div class="post">
			<p>Etsy open-sourced their deployment tool a while back, but I didn’t learn about it until more recently. It is called <a href="https://github.com/etsy/deployinator">Deployinator</a> and runs on Ruby. I’m looking at using it for a project at work, but I ran into a horrible lack of documentation. The one example that is in the repo isn’t bad, it just doesn’t show you how to have multiple deploy buttons. In the case I may use it in, I will need multiple. If you aren’t sure what I mean by “multiple deploy buttons” check out the picture on <a href="http://codeascraft.com/2010/05/20/quantum-of-deployment/">this page</a>.</p>

<p>After digging through the code I finally got that working and I think others might want to avoid digging through the code.</p>

<p>If you don’t configure the buttons, called environments, then you get one “Deploy production” button, like you see below.</p>

<p><a href="/assets/img/posts/etsy-deployinator-00.png" class="th radius" style="display: inline-block;">
	<img src="/assets/img/posts/etsy-deployinator-00.png" alt="Deployinator default enviroment" />
</a></p>

<p>Below is what you get for the demo stack. Only a few of the methods are actually required for the default setup. The required methods for the default setup are <code>demo_production</code>, <code>demo_production_version</code>, and <code>demo_head_build</code>.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Deployinator</span>
  <span class="k">module</span> <span class="nn">Stacks</span>
    <span class="k">module</span> <span class="nn">Demo</span>
      <span class="k">def</span> <span class="nf">demo_git_repo_url</span>
        <span class="s2">&quot;git://github.com/etsy/statsd.git&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">demo_git_checkout_path</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">checkout_root</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">checkout_root</span>
        <span class="s2">&quot;/tmp&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">demo_production_version</span>
        <span class="sx">%x{cat </span><span class="si">#{</span><span class="n">demo_git_checkout_path</span><span class="si">}</span><span class="sx">/version.txt}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">demo_production_build</span>
        <span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="n">demo_production_version</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">demo_head_build</span>
        <span class="sx">%x{git ls-remote </span><span class="si">#{</span><span class="n">demo_git_repo_url</span><span class="si">}</span><span class="sx"> HEAD | cut -c1-7}</span><span class="o">.</span><span class="n">chomp</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">demo_production</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">old_build</span> <span class="o">=</span> <span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="n">demo_production_version</span><span class="p">)</span>

        <span class="n">git_cmd</span> <span class="o">=</span> <span class="n">old_build</span> <span class="p">?</span> <span class="ss">:git_freshen_clone</span> <span class="p">:</span> <span class="ss">:github_clone</span>
        <span class="nb">send</span><span class="p">(</span><span class="n">git_cmd</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="s2">&quot;sh -c&quot;</span><span class="p">)</span>

        <span class="n">git_bump_version</span> <span class="n">stack</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="n">build</span> <span class="o">=</span> <span class="n">demo_head_build</span>

        <span class="k">begin</span>
          <span class="n">run_cmd</span> <span class="sx">%Q{echo &quot;ssh host do_something&quot;}</span>
          <span class="n">log_and_stream</span> <span class="s2">&quot;Done!&lt;br&gt;&quot;</span>
        <span class="k">rescue</span>
          <span class="n">log_and_stream</span> <span class="s2">&quot;Failed!&lt;br&gt;&quot;</span>
        <span class="k">end</span>

        <span class="c1"># log this deploy / timing</span>
        <span class="n">log_and_shout</span><span class="p">(</span><span class="ss">:old_build</span> <span class="o">=&gt;</span> <span class="n">old_build</span><span class="p">,</span> <span class="ss">:build</span> <span class="o">=&gt;</span> <span class="n">build</span><span class="p">,</span> <span class="ss">:send_email</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>The code that sets up the environments is in <code>helpers.rb</code>. The environments are defined by an array of hashes, this is what the code for the default environment looks like:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="p">{</span>
  <span class="ss">:name</span>            <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
  <span class="ss">:title</span>           <span class="o">=&gt;</span> <span class="s2">&quot;Deploy </span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2"> production&quot;</span><span class="p">,</span>
  <span class="ss">:method</span>          <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2">_production&quot;</span><span class="p">,</span>
  <span class="ss">:current_version</span> <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_production_version&quot;</span><span class="p">)},</span>
  <span class="ss">:current_build</span>   <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_production_version&quot;</span><span class="p">))},</span>
  <span class="ss">:next_build</span>      <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:head_build</span><span class="p">)}</span>
<span class="p">}</span><span class="o">]</span></code></pre></div>

<p>Once I found this code, and found the typo in my method name I was easily able to add more environments. To add environments to the demo stack that is provided all you have to do is define a <code>demo_environments</code> method in the stack file. Below is an example with a qa and production environment defined in a dynamic way.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">demo_environment</span>
  <span class="o">[</span><span class="p">{</span>
    <span class="ss">:name</span>            <span class="o">=&gt;</span> <span class="s2">&quot;qa&quot;</span><span class="p">,</span>
    <span class="ss">:title</span>           <span class="o">=&gt;</span> <span class="s2">&quot;Deploy </span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2"> qa&quot;</span><span class="p">,</span>
    <span class="ss">:method</span>          <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2">_qa&quot;</span><span class="p">,</span>
    <span class="ss">:current_version</span> <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_qa_version&quot;</span><span class="p">)},</span>
    <span class="ss">:current_build</span>   <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_qa_version&quot;</span><span class="p">))},</span>
    <span class="ss">:next_build</span>      <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:head_build</span><span class="p">)}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="ss">:name</span>            <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
    <span class="ss">:title</span>           <span class="o">=&gt;</span> <span class="s2">&quot;Deploy </span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2"> production&quot;</span><span class="p">,</span>
    <span class="ss">:method</span>          <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="s2">_production&quot;</span><span class="p">,</span>
    <span class="ss">:current_version</span> <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_production_version&quot;</span><span class="p">)},</span>
    <span class="ss">:current_build</span>   <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="n">stack</span><span class="si">}</span><span class="ss">_production_version&quot;</span><span class="p">))},</span>
    <span class="ss">:next_build</span>      <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:head_build</span><span class="p">)}</span>
  <span class="p">}</span><span class="o">]</span>
<span class="k">end</span></code></pre></div>

<p>After adding this environment you will need to add a few additional methods ( <code>demo_qa</code> and <code>demo_qa_version</code> ). If you wanted you could also define the environments like so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">demo_environment</span>
  <span class="o">[</span><span class="p">{</span>
    <span class="ss">:name</span>            <span class="o">=&gt;</span> <span class="s2">&quot;qa&quot;</span><span class="p">,</span>
    <span class="ss">:title</span>           <span class="o">=&gt;</span> <span class="s2">&quot;Deploy demo qa&quot;</span><span class="p">,</span>
    <span class="ss">:method</span>          <span class="o">=&gt;</span> <span class="s2">&quot;demo_qa&quot;</span><span class="p">,</span>
    <span class="ss">:current_version</span> <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:demo_qa_version</span><span class="p">)},</span>
    <span class="ss">:current_build</span>   <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="ss">:demo_qa_version</span><span class="p">))},</span>
    <span class="ss">:next_build</span>      <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:head_build</span><span class="p">)}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="ss">:name</span>            <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
    <span class="ss">:title</span>           <span class="o">=&gt;</span> <span class="s2">&quot;Deploy demo production&quot;</span><span class="p">,</span>
    <span class="ss">:method</span>          <span class="o">=&gt;</span> <span class="s2">&quot;demo_production&quot;</span><span class="p">,</span>
    <span class="ss">:current_version</span> <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:demo_production_version</span><span class="p">)},</span>
    <span class="ss">:current_build</span>   <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="no">Version</span><span class="o">.</span><span class="n">get_build</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="ss">:demo_production_version</span><span class="p">))},</span>
    <span class="ss">:next_build</span>      <span class="o">=&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">send</span><span class="p">(</span><span class="ss">:head_build</span><span class="p">)}</span>
  <span class="p">}</span><span class="o">]</span>
<span class="k">end</span></code></pre></div>

<p>Here is what you end up with.</p>

<p><a href="/assets/img/posts/etsy-deployinator-01.png" class="th radius" style="display: inline-block;">
	<img src="/assets/img/posts/etsy-deployinator-01.png" alt="Deployinator default enviroment" />
</a></p>

<p>So far this has been the biggest thing that wasn’t explained. Anything else I come across I’ll add here as well.</p>

		</div>
	</div>
</div>

<div class="row">
	<div class="small-12 columns">
		<hr>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'jasonbutzblog'; // required: replace example with your forum shortname
			var disqus_identifier = '/blog/2013/07/31/etsy-deployinator-environments';
			var disqus_title = 'Etsy Deployinator Environments';
			var disqus_url = 'http://www.jasonbutz.info/blog/2013/07/31/etsy-deployinator-environments.html';

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>

		</div>
	</section>
	<footer>
		<div class="row">
			<div class="small-12 columns">
				<p>
					<small><a href="http://www.jasonbutz.info/blog/atom.xml" title="Blog RSS Feed"><i class="foundicon-rss">&nbsp;Blog RSS Feed</i></a></small>
					&nbsp;&nbsp;
					<small><a href="http://www.jasonbutz.info/project/atom.xml" title="Projects RSS Feed"><i class="foundicon-rss">&nbsp;Projects RSS Feed</i></a></small>
					<br />
					<small>Jason Butz &copy; 2012 - 2015</small><br>
				</p>
			</div>
		</div>
	</footer>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/foundation.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/foundation/foundation.topbar.min.js"></script>
	<script type="text/javascript">$(document).foundation();</script>
	<!-- <script type="text/javascript" src="/assets/js/site.js"></script> -->
<script src='/assets/global-165f05faaf9ee3e1184dcce0ebb5b2a7.js' type='text/javascript'></script>

	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-45171709-1', 'jasonbutz.info');
		ga('send', 'pageview');
	</script>
	<!--[if !(lte IE 8)]><!--> 
	<script type="text/javascript"> 
	(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src=document.location.protocol+"//d1agz031tafz8n.cloudfront.net/thedaywefightback.js/widget.min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
	</script>
	<!--<![endif]-->
</body>
</html>