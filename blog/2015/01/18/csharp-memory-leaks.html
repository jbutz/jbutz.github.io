<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Jason Butz - C# Memory Leaks</title>
	<meta name="viewport" content="width=device-width">

	<link rel="alternate" type="application/rss+xml" title="Blog Feed" href="http://www.jasonbutz.info/blog/atom.xml" />
	<link rel="alternate" type="application/rss+xml" title="Projects Feed" href="http://www.jasonbutz.info/project/atom.xml" />

	<!-- Foundation -->
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/css/normalize.min.css"/>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/css/foundation.min.css"/>
	<link rel="stylesheet" href="/assets/css/social_foundicons.css"/>

	<link rel="stylesheet" href="/assets/css/syntax.css">
	<link rel="stylesheet" type="text/css" href="/assets/css/style.css" />

	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/vendor/custom.modernizr.min.js"></script>
	<script type="text/javascript" src="/assets/js/plugins.js"></script>
</head>
<body>
	<header>
		<div class="row">
			<div class="small-8 large-6 columns">
				<h1><a href="/">Jason Butz</a></h1>
			</div>
			<div class="small-4 large-6 columns">
				<nav class="contain-to-grid">
					<div class="top-bar">
						<ul class="title-area">
							<li class="name"><!-- Leave this empty --></li>
							<li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
						</ul>
						<section class="top-bar-section">
							<ul class="right">
								<li class="active"><a href="/">Home</a></li>
								<li><a href="/projects.html">Projects</a></li>
								<li><a href="/blog">Blog</a></li>
								<li><a href="/contact.html">Contact Me</a></li>
							</ul>
						</section>
					</div>
				</nav>
			</div>
		</div>
	</header>

	<section id="mainContent">
		<div class="small-12 large-8 large-centered columns">
<div class="row">
	<div class="small-12 columns">
		<h2>C# Memory Leaks <small>18 Jan 2015</small></h2>
	</div>
</div>
<div class="row">
	<div class="small-12 columns">
		<div class="post">
			<p>For the past three or four work days I have been trying to find a memory leak in a Windows Service we created that is used to synchronize data between two systems on a nightly basis. I had just added a single method to it for a new job and the memory usage was climbing until it hit the 2GB process limit.</p>

<p>At first I thought it might be something going wrong in my <code>foreach</code> loop. That was the only thing I added running enough to create that kind of usage. I was looping over 200,000 items for the initial sync so all it wouldn’t be that hard if I had a object keeping track of everything I synced. But I didn’t have any of that. I went through my loop several times. Then I started wondering about the method generating the API calls to the other system. If something was going wrong there it would easily explain the memory usage. I had to make up to 3 API calls for each loop iteration.</p>

<p>At first I thought it might be because the class for making the API calls was static and I saw an article that said static objects aren’t garbage collected, so I started digging through there but couldn’t find anything. Then I decided I needed to confirm a memory leak. I pulled out Performance Monitor and set it to track the <em>Private Bytes</em> for my process. Sure enough as soon as I triggered the sync the memory usage steadily took off. Once I had whittled down the objects I had to work on so I wouldn’t run out of process memory I saw that when it was done it wouldn’t release the memory. Now I really had to find the problem, restarting the service nightly wouldn’t be viable.</p>

<p>I found a tool called <a href="http://www.microsoft.com/en-us/download/details.aspx?id=42933">DebugDiag</a> and that proved invaluable. I was able to create a dump of the process and then generate a report. That report had a great warning at the top that lead me to an <a href="http://blogs.msdn.com/b/tess/archive/2006/02/15/532804.aspx">article</a> explaining exactly what was going on.</p>

<p><img src="/assets/img/posts/csharp-memory-leaks00.png" alt="DebugDiag Results" /></p>

<p>As it turns out <code>XmlSerializer</code> will generate a new temporary assembly when the constructor is called. In my case, up to 6 calls for each loop iteration covers the memory issue I was having. XmlSerializer was being used for tracing and was surrounded by preprocessor directives, so if I had compiled for production instead of debugging the issue would never have shown itself. One of my coworkers had that code there because he needed it for debugging some issues, so I commented it out and added a warning about the memory issue.</p>

<p>Now the service runs with a maximum of 56MB of memory as opposed to shooting up to 2GB. The problem may not have shown up in production, but at least we know about <code>XmlSerializer</code> for the future. If you can help it instantiate it once and use that over and over.</p>

		</div>
	</div>
</div>

<div class="row">
	<div class="small-12 columns">
		<hr>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'jasonbutzblog'; // required: replace example with your forum shortname
			var disqus_identifier = '/blog/2015/01/18/csharp-memory-leaks';
			var disqus_title = 'C# Memory Leaks';
			var disqus_url = 'http://www.jasonbutz.info/blog/2015/01/18/csharp-memory-leaks.html';

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>

		</div>
	</section>
	<footer>
		<div class="row">
			<div class="small-12 columns">
				<p>
					<small><a href="http://www.jasonbutz.info/blog/atom.xml" title="Blog RSS Feed"><i class="foundicon-rss">&nbsp;Blog RSS Feed</i></a></small>
					&nbsp;&nbsp;
					<small><a href="http://www.jasonbutz.info/project/atom.xml" title="Projects RSS Feed"><i class="foundicon-rss">&nbsp;Projects RSS Feed</i></a></small>
					<br />
					<small>Jason Butz &copy; 2012 - 2015</small><br>
				</p>
			</div>
		</div>
	</footer>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/foundation.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/foundation/4.1.6/js/foundation/foundation.topbar.min.js"></script>
	<script type="text/javascript">$(document).foundation();</script>
	<!-- <script type="text/javascript" src="/assets/js/site.js"></script> -->
<script src='/assets/global-165f05faaf9ee3e1184dcce0ebb5b2a7.js' type='text/javascript'></script>

	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-45171709-1', 'jasonbutz.info');
		ga('send', 'pageview');
	</script>
	<!--[if !(lte IE 8)]><!--> 
	<script type="text/javascript"> 
	(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src=document.location.protocol+"//d1agz031tafz8n.cloudfront.net/thedaywefightback.js/widget.min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
	</script>
	<!--<![endif]-->
</body>
</html>